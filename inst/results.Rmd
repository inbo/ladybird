---
title: "Results"
author: "Thierry Onkelinx"
date: "8-3-2021"
output: html_document
params:
  models:
    label: "Select a base model"
    value: "../../Analysis/models/base/harm_axyr_1000_3.rds"
    input: file
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, error = FALSE)
options(knitr.kable.NA = '')
library(ladybird)
library(tidyverse)
library(plotly)
library(scales)
library(INBOtheme)
```

```{r load-models, results = "hide"}
dirname(params$models) %>%
  file.path("..") %>%
  list.files(full.names = TRUE, recursive = TRUE) %>%
  str_subset(pattern = "smoother", negate = TRUE) %>%
  map(readRDS) -> base_models
species <- map_chr(base_models, "species")
waic <- map_dbl(base_models, "waic")
model_type <- map_chr(base_models, "type")
country <- map_chr(base_models, "country")
map(base_models, "hyperpar") %>%
  map(rownames_to_column, var = "parameter") %>%
  map2(species, ~mutate(.x, species = .y)) %>%
  map2(model_type, ~mutate(.x, model = .y)) %>%
  map2(country, ~mutate(.x, country = .y)) %>%
  bind_rows() -> hyperpar
map(base_models, "fixed") %>%
  map(rownames_to_column, var = "parameter") %>%
  map2(species, ~mutate(.x, species = .y)) %>%
  map2(model_type, ~mutate(.x, model = .y)) %>%
  map2(country, ~mutate(.x, country = .y)) %>%
  bind_rows() -> fixed
map(base_models, "trend") %>%
  map2(species, ~mutate(.x, species = .y)) %>%
  map2(model_type, ~mutate(.x, model = .y)) %>%
  map2(country, ~mutate(.x, country = .y)) %>%
  bind_rows() %>%
  mutate(
    type = replace_na(type, ""),
    prediction = interaction(model, type, sep = " "), 
    component = ifelse(is.na(iyear), "linear", "linear + rw")
  ) -> trend
map(base_models, "roc") %>%
  map("ci") %>%
  map(
    ~data.frame(parameter = c("lcl", "estimate", "ucl"), auc = as.vector(.x))
  ) %>%
  map2(species, ~mutate(.x, species = .y)) %>%
  map2(model_type, ~mutate(.x, model = .y)) %>%
  map2(country, ~mutate(.x, country = .y)) %>%
  bind_rows() -> auc
map(base_models, "field") %>%
  map2(species, ~mutate(.x, species = .y)) %>%
  map2(model_type, ~mutate(.x, model = .y)) %>%
  map2(country, ~mutate(.x, country = .y)) %>%
  bind_rows() -> field
map(base_models, "lincomb") %>%
  map2(species, ~mutate(.x, species = .y)) %>%
  map2(model_type, ~mutate(.x, model = .y)) %>%
  map2(country, ~mutate(.x, country = .y)) %>%
  bind_rows() -> lincomb
rm(base_models)
gc()
```

# Compare models

## Base model

Let $Y_{tx}$ be the occurrence of a species in year $t$ at square $x$.
$Y_{tx} = 1$ when we have at least one record of the species in year $t$ at square $x$.
$Y_{tx} = 0$ when no records of the species in year $t$ at square $x$ but at least 3 other species (excluding _H. axyridis_) recorded.
Then $\pi_{tx}$ is the probability of occurrence in year $t$ at square $x$.

$$Y_{tx} \sim \mathcal{Bernoulli(\pi_{tx})}$$

We use the $\mbox{logit}$ link between $\pi_{tx}$ and the linear predictor $\eta_{tx}$.

$$\eta_{tx} = \log\big(\frac{\pi_{tx}}{1 - \pi_{tx}}\big)$$

The linear predictor consists of four components.
- $E_{tx}$: the monitoring effort.
- $\beta_k$: a segmented regression modelling the global linear trend per decade.
- $b_t$: a first order random walk along $t$, modelling deviations from the linear trend per decade.
- $\omega_{tx}$: Gaussian Markov Random Field (GMRF) with temporal correlation, modelling the residual spatio-temporal autocorrelation.

$$\eta_{tx} = E_{tx} + \beta_k + b_t + \omega_{tx}$$

We base the monitoring effect on the unique number of days with recordings $d_{tx}$ in year $t$ at square $x$.

$$E_{tx} = \beta_d \log d_{tx}$$

We model the global linear trend per decade by defining knot $k_i$ at the start of each decade.
We define a weight variable $A_i$ for each knot $k_i$.

$$\beta_k = \beta_{1990} A_{1990} + \beta_{2000} A_{2000} + \beta_{2010} A_{2010}+ \beta_{2020} A_{2020}$$

These weight variables are by default $A_i = 0$.
In the special case when year $t$ coincides with a knot then $A_i = 1$ when $t = k_i$, otherwise $A_i = 0$.
When year $t$ is between two consecutive knots $k_i$ and $k_{i + 1}$ ($k_i < t < k_{i + 1}$).
Then we defines the weight variables $A_i$ and $A_{i+1}$ as follows, so that $0 \le A_i \le 1$.

$$A_i = \frac{(k_{i-1} - k_i) - (t - k_i)}{(k_{i-1} - k_i)} \quad \quad A_{i+1} = \frac{t - k_i}{(k_{i-1} - k_i)} $$

$\beta_{k_i}$ will thus depend on the average probability at knot $k_i$.
The average probability for an intermediate year is a linear interpolation between the nearest knots.


The first order random walk models any global deviations from the global linear trend per decade.
The random steps follow a Gaussian distribution with mean $0$ and variance $\sigma^2_r$.

$$b_t - b_{t - 1} \sim \mathcal{N}(0, \sigma^2_r)$$

We model the spatio-temporal autocorrelation $\omega_{tx}$ as an AR-1 correlation between Gaussian Markhov Random Fields (GMRF) $\xi_{tx}$.
$\rho$ is temporal autocorrelation between two consecutive GMRF's.
$$\omega_{tx} = \rho\omega_{t-1x} + \xi_{tx}$$

The individual GRMF $\xi_{tx}$ are independent but share the $r$ and $\sigma^2_s$ parameters.
$\sigma^2_s$ is variance of the GMRF at distances larger than $r$.
While $C(\Delta_{xy})$ the distance based correlation between locations $x$ and $y$, with $\Delta_{xy}$ being the distance between locations $x$ and $y$.

$$\xi_x \sim \mathcal{N}(0, \sigma^2_sC(\Delta_{xy}))$$

$C(\Delta_{xy})$ is defined as below with 
- $K_\lambda$: modified Bessel function of the second kind;
- $\lambda > 0$: parameter defining the smoothness of the GMRF;
- $\kappa > 0$: scaling parameter

$$C(\Delta_{xy}) = \frac{1}{\Gamma(\lambda) 2 ^{\lambda - 1}} (\kappa \Delta_{xy}) ^\lambda K_\lambda (\kappa \Delta_{xy})$$
We combined the $\lambda$ and $\kappa$ parameters into a single $r$ parameter.
This is the range of the spatial autocorrelation: the distance at which the correlation between two location location drops below $0.1$.

$$r = \frac{\sqrt{8\lambda}}{\kappa}$$
## Including the predicted occurrence probability for _H. axyridis_

We add a fifth component to the linear predictor $\eta_{tw}$: an interaction between the global linear trend per decade $\beta_k$ and the predicted occurrence probability for _H. axyridis_ on the logit scale.
The latter is $\eta_{tx}$ of the base model for _H. axyridis_ which we note as $\eta_{tx}^{Ha}$.

$$\eta_{tx} = E_{tx} + \beta_k + \beta_k \eta_{tx}^{Ha} + b_t + \omega_{tx}$$

_H. axyridis_ appeared during the early years of the second decade (2000-2010).
Therefore we had to remove all years prior to the first occurrence except the year just before the first occurrence.
As a consequence we had to drop the 1990 for the _H. axyridis_ base model and we have no prediction for the early years.
We solved the lack of predictions for the early years by replacing the missing predictions with the lowest observed $\eta_{tx}^{Ha}$.

## Using the cumulative probability of _H. axyridis_

Here we use interaction between the cumulative predicted probability of _H. axyridis_ ($\pi_{tx}^{Ha}$) and the global linear trend per decade $\beta_k$ as fifth component.
The cumulative predicted probability is a proxy for the number of years _H. axyridis_ was present in year $t$ at a square $x$.
We assumed $\pi_{tx}^{Ha} = 0$ when we had no predictions for the early years of the dataset.

$$\eta_{tx} = E_{tx} + \beta_k + \beta_k \sum_{i = 1}^t\pi_{ix} + b_t + \omega_{tx}$$

# Comparing fits

```{r waic}
data.frame(species, waic, model = model_type, country = country) %>%
  group_by(species, country) %>%
  mutate(
    waic = waic - min(waic),
    model = factor(model, levels = c("base", "probability", "cumulative"))
  ) %>%
  arrange(waic) -> delta_waic
delta_waic %>%
  filter(waic < 2) %>%
  summarise(
    best = paste(sort(model), collapse = " / "),
    .groups = "drop"
  ) -> best_model
delta_waic %>%
  pivot_wider(names_from = model, values_from = waic) %>%
  inner_join(best_model, by = c("species", "country")
  ) %>%
  arrange(best) %>%
  kable(
    digits = 1,
    caption = 
  "Difference in WAIC compared to the model with lowest WAIC for each species
and country.
Smaller is better."
  )
```


```{r keep-best-models}
best_model %>%
  mutate(model = str_remove(best, " .*")) -> best_model
auc %>%
  semi_join(best_model, by = c("species", "country", "model")) -> auc
fixed %>%
  semi_join(best_model, by = c("species", "country", "model")) -> fixed
trend %>%
  semi_join(best_model, by = c("species", "country", "model")) %>%
  mutate(
    id = interaction(species, country, sep = "-") %>%
      str_replace("_", "-")
  ) -> trend
lincomb %>%
  semi_join(best_model, by = c("species", "country", "model")) -> lincomb
hyperpar %>%
  semi_join(best_model, by = c("species", "country", "model")) -> hyperpar
```


```{r auc, fig.cap = "Area under the curve. Higher is better."}
auc %>%
  pivot_wider(names_from = parameter, values_from = auc) %>%
  mutate(
    species = reorder(species, estimate),
  ) %>%
  ggplot(
    aes(
      x = estimate, xmin = lcl, xmax = ucl, y = species, colour = model,
      linetype = country, shape = country
    )
  ) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  theme(axis.title = element_blank()) +
  ggtitle("AUC")
```

# Fixed effects

## Effect of number of days

```{r logvisit, fig.cap = "Parameter estimates for log number of days."}
fixed %>%
  filter(parameter == "log_visits") %>%
  mutate(
    species = reorder(species, mean)
  ) %>%
  ggplot(
    aes(
      x = mean, xmin = `0.025quant`, xmax = `0.975quant`, y = species,
      colour = country
    )
  ) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  theme(axis.title = element_blank())
```

## Knots

```{r knots-knot, fig.cap = "Parameters for the knot components split by knot."}
fixed %>%
  filter(str_detect(parameter, "knot")) %>%
  mutate(
    secondary = str_detect(parameter, "secondary"),
    knot = str_replace(parameter, "knot_([0-9]{4}).*", "\\1"),
    median = `0.5quant`,
    lcl = `0.025quant`,
    ucl = `0.975quant`,
    species = reorder(species, median)
  ) -> fixed_knots
fixed_knots %>%
  ggplot(
    aes(
      x = median, xmin = lcl, xmax = ucl, y = species, colour = country,
      linetype = secondary, shape = secondary
    )
  ) +
  geom_errorbarh(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5)) +
  theme(axis.title = element_blank()) +
  facet_wrap(~knot)
```

```{r knots-country}
ggplot(
  fixed_knots,
  aes(
    x = median, xmin = lcl, xmax = ucl, y = species, colour = knot,
    linetype = secondary, shape = secondary
  )
) +
  geom_errorbarh(position = position_dodge(0.5)) +
  geom_point(position = position_dodge(0.5)) +
  theme(axis.title = element_blank()) +
  facet_wrap(~country)
```

## Trends based on difference between knots

```{r trends, fig.cap = "log odd ratio for trends over decades based on only main effects."}
lincomb %>%
  mutate(
    effect = ifelse(
      str_detect(decade, ":"),
      str_remove(decade, ".*:"),
      "2"
    ) %>%
      factor(
        levels = c("2", "0", "1"), labels = c("main", "interaction", "combined")
      ),
    decade = str_remove(decade, ":.*"),
    species = reorder(species, mean)
  ) -> lc
lc %>%
  filter(effect == "main") %>%
  ggplot(
    aes(
      x = mean, xmin = lcl, xmax = ucl, y = species,
      colour = decade
    )
  ) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  facet_wrap(~country) +
  theme(axis.title = element_blank())
```

```{r trends-interaction, fig.cap = "log odd ratio for main and interaction trends over decades. Only for species with an interaction model"}
lc %>%
  filter(model != "base", effect != "combined") %>%
  ggplot(
    aes(
      x = mean, xmin = lcl, xmax = ucl, y = species, colour = country,
      linetype = effect, shape = effect
    )
  ) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  facet_wrap(~decade) +
  theme(axis.title = element_blank())
```

# General trends

- **min**: prediction using the minimum predicted occurrence of _H. axyridis_ for that year
- **max**: prediction using the maximum predicted occurrence of _H. axyridis_ for that year
- **median**: prediction using the median predicted occurrence of _H. axyridis_ for that year
- **without**: prediction assuming the predicted occurrence of _H. axyridis_ is 0%

```{r species_trends, results = "asis"}
unique(trend$id) %>%
  sapply(
    function(id) {
      knit_expand("_trend.Rmd", id = id)
    }
  ) %>%
  paste(collapse = "\n") -> rmd
knit(text = rmd, quiet = TRUE) %>%
  cat()
```

# Spatio-temporal fields

```{r sec-range}
hyperpar %>%
  filter(parameter == "Range for site") %>%
  mutate(
    species = reorder(species, mean)
  ) %>%
  ggplot(
    aes(
      x = mean, xmin = `0.025quant`, xmax = `0.975quant`, y = species,
      colour = country
    )
  ) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_x_continuous(limits = c(0, NA)) +
  ggtitle("Range of the spatio-temporal field in km") +
  theme(axis.title = element_blank())
```

```{r sec-stdev}
hyperpar %>%
  filter(parameter == "Stdev for site") %>%
  mutate(
    species = reorder(species, mean)
  ) %>%
  ggplot(
    aes(
      x = mean, xmin = `0.025quant`, xmax = `0.975quant`, y = species,
      colour = country
    )
  ) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  scale_x_continuous(limits = c(0, NA)) +
  ggtitle("Stdev of the spatio-temporal field") +
  theme(axis.title = element_blank())
```

```{r sec-rho}
hyperpar %>%
  filter(parameter == "GroupRho for site", !is.na(mean)) %>%
  mutate(
    species = reorder(species, mean)
  ) %>%
  ggplot(
    aes(
      x = mean, xmin = `0.025quant`, xmax = `0.975quant`, y = species,
      colour = country
    )
  ) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  ggtitle("Rho of the spatio-temporal field in km") +
  theme(axis.title = element_blank())
```

# Random walk hyper parameters

```{r sigma-p}
hyperpar %>%
  filter(parameter == "Precision for iyear", !is.na(mean)) %>%
  mutate(
    species = reorder(species, mean),
    median = sqrt(1 / `0.5quant`),
    lcl = sqrt(1 / `0.025quant`),
    ucl = sqrt(1 / `0.975quant`)
  ) %>%
  ggplot(
    aes(x = median, xmin = lcl, xmax = ucl, y = species, colour = country)
  ) +
  geom_errorbarh(position = position_dodge(width = 0.5)) +
  geom_point(position = position_dodge(width = 0.5)) +
  ggtitle("Stdev for the random walk") +
  scale_x_continuous(limits = c(0, NA)) +
  theme(axis.title = element_blank())
```
